<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Sensor Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- ‚úÖ Leaflet CSS (MAP) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
/* --- BASIC LAYOUT --- */
body {
  margin: 0;
  background: #1b2230;
  font-family: 'Inter', sans-serif;
  color: #e5e7eb;
}
header {
  height: 60px;
  background: #111827;
  display: flex;
  align-items: center;
  padding: 0 20px;
  font-weight: 600;
}
.container {
  padding: 20px;
  max-width: 1300px;
  margin: auto;
}
.grid {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 20px;
}
.card {
  background: #222a3b;
  border-radius: 14px;
  padding: 20px;
  min-width: 0;
}
.card-title {
  font-size: 13px;
  color: #9ca3af;
  margin-bottom: 10px;
}
.value {
  font-size: 26px;
  font-weight: 600;
}

/* --- SPLIT GRAPH LAYOUT --- */
.chart-container {
  display: flex;
  height: 300px;
  width: 100%;
  position: relative;
}

/* LEFT: Fixed Axis */
.y-axis-area {
  width: 120px;
  flex-shrink: 0;
  background: #222a3b;
  z-index: 10;
  border-right: 1px solid #374151;
}

/* RIGHT: Scrollable Data */
.graph-scroll-area {
  flex-grow: 1;
  overflow-x: hidden;
  overflow-y: hidden;
  position: relative;
}

#chartWrapper {
  width: max-content;
  height: 100%;
}

canvas {
  height: 300px !important;
}

/* --- BUTTONS --- */
.controls {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}
.nav-btn {
  background: #374151;
  color: white;
  border: none;
  padding: 8px 15px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
  flex: 1;
}
.nav-btn:hover { background: #4b5563; }

.action-btn {
  margin-top: 15px;
  padding: 12px;
  width: 100%;
  background: #3b82f6;
  border: none;
  border-radius: 10px;
  color: white;
  font-weight: 600;
  cursor: pointer;
}

/* --- METRICS --- */
.metrics {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 15px;
  margin-top: 20px;
}
.metric {
  background: #222a3b;
  border-radius: 14px;
  padding: 15px;
}
.status-safe { color: #22c55e; }
.status-unsafe { color: #ef4444; }

@media (max-width: 900px) {
  .grid { grid-template-columns: 1fr; }
  .metrics { grid-template-columns: repeat(2, 1fr); }
}

/* ‚úÖ WQI CARD STYLE */
.wqi-card{
  margin-top: 20px;
  background: #222a3b;
  border-radius: 14px;
  padding: 18px;
}
.wqi-top{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:12px;
}
.wqi-title{
  font-size: 13px;
  color:#9ca3af;
  font-weight:600;
}
.wqi-score{
  font-size:18px;
  font-weight:700;
}
.wqi-bar-bg{
  width:100%;
  height:18px;
  background:#111827;
  border-radius: 999px;
  overflow:hidden;
  border:1px solid #374151;
}
.wqi-bar-fill{
  height:100%;
  width:0%;
  border-radius:999px;
  transition: width 0.5s ease;
}

/* ‚úÖ MAP CARD STYLE */
.map-card {
  margin-top: 20px;
  background: #222a3b;
  border-radius: 14px;
  padding: 15px;
}
#map {
  height: 350px;
  width: 100%;
  border-radius: 12px;
  overflow: hidden;
}
</style>
</head>

<body>

<header>Sensor Dashboard</header>

<div class="container">
<div class="grid">

<div class="card">
  <div class="card-title">HISTORICAL SENSOR DATA</div>

  <select id="metricSelect" style="
    background:#111827; color:white; border:none;
    padding:6px 10px; border-radius:6px; margin-bottom:10px;">
    <option value="tds">TDS</option>
    <option value="pH">pH</option>
    <option value="temp">Temperature</option>
    <option value="turb">Turbidity</option>
  </select>

  <div class="chart-container">
    <div class="y-axis-area">
      <canvas id="axisChart"></canvas>
    </div>
    <div class="graph-scroll-area" id="scrollBox">
      <div id="chartWrapper">
        <canvas id="dataChart"></canvas>
      </div>
    </div>
  </div>

  <div class="controls">
    <button class="nav-btn" id="scrollLeft"> &larr; Prev </button>
    <button class="nav-btn" id="scrollRight"> Next &rarr; </button>
  </div>
</div>

<div class="card">
  <div class="card-title">CURRENT READINGS</div>
  <div class="value" id="ph">pH: --</div>
  <div class="value" id="tds">TDS: -- ppm</div>
  <div class="value" id="temp">Temp: -- ¬∞C</div>
  <div class="value" id="turb">Turbidity: --</div>
  <div class="value" id="status">Status: --</div>
  <button class="action-btn" id="fetchBtn">Fetch Latest Reading</button>
</div>

</div>

<div class="metrics">
  <div class="metric">
    <div class="card-title">pH LEVEL</div>
    <div class="value" id="phMetric">--</div>
  </div>
  <div class="metric">
    <div class="card-title">TDS (ppm)</div>
    <div class="value" id="tdsMetric">--</div>
  </div>
  <div class="metric">
    <div class="card-title">TEMPERATURE</div>
    <div class="value" id="tempMetric">-- ¬∞C</div>
  </div>
  <div class="metric">
    <div class="card-title">TURBIDITY</div>
    <div class="value" id="turbMetric">--</div>
  </div>
</div>

<!-- ‚úÖ WQI CARD -->
<div class="wqi-card">
  <div class="wqi-top">
    <div class="wqi-title">WQI (Water Quality Index) ‚Ä¢ 0 = Bad, 100 = Perfect</div>
    <div class="wqi-score" id="wqiScore">-- / 100</div>
  </div>
  <div class="wqi-bar-bg">
    <div class="wqi-bar-fill" id="wqiFill"></div>
  </div>
</div>

<!-- ‚úÖ MAP -->
<div class="map-card">
  <div class="card-title">LIVE LOCATION MAP</div>
  <div id="map"></div>
</div>

</div>

<div style="margin-top:20px;">
  <button id="resetBtn" style="
    width:100%;
    padding:14px;
    border:none;
    border-radius:12px;
    background:#ef4444;
    color:white;
    font-size:16px;
    font-weight:700;
    cursor:pointer;
  ">
    ‚ö†Ô∏è RESET ALL DATA
  </button>
</div>


<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
const wsProtocol = (location.protocol === "https:") ? "wss://" : "ws://";
const ws = new WebSocket(wsProtocol + location.host);

const FIREBASE_DB = "https://water-sensor-project-default-rtdb.asia-southeast1.firebasedatabase.app";
const DEVICE_ID = "device1";
const FIREBASE_HISTORY_URL = `${FIREBASE_DB}/devices/${DEVICE_ID}/history.json`;
const FIREBASE_LATEST_URL = `${FIREBASE_DB}/devices/${DEVICE_ID}/latest.json`;

// --- SETTINGS ---
const POINT_WIDTH = 100;
let fullHistory = [];
let currentMetric = "tds";

const scrollBox = document.getElementById("scrollBox");
const chartWrapper = document.getElementById("chartWrapper");

// ‚úÖ WQI CALCULATION
function calcWQI(d) {
  const clamp = (v, min, max) => Math.max(min, Math.min(max, v));

  let scorePH = 100;
  if (d.pH < 6.5) scorePH = 100 - ((6.5 - d.pH) * 25);
  if (d.pH > 8.5) scorePH = 100 - ((d.pH - 8.5) * 25);
  scorePH = clamp(scorePH, 0, 100);

  let scoreTDS = 100;
  if (d.tds <= 300) scoreTDS = 100;
  else if (d.tds <= 500) scoreTDS = 70;
  else scoreTDS = 30;

  let scoreTEMP = 100;
  if (d.temp <= 30) scoreTEMP = 100;
  else if (d.temp <= 35) scoreTEMP = 70;
  else scoreTEMP = 30;

  let scoreTURB = 100;
  if (d.turb <= 5) scoreTURB = 100;
  else if (d.turb <= 10) scoreTURB = 70;
  else scoreTURB = 30;

  const wqi = (scorePH * 0.35) + (scoreTDS * 0.25) + (scoreTURB * 0.25) + (scoreTEMP * 0.15);
  return Math.round(clamp(wqi, 0, 100));
}

function setWQIUI(wqi) {
  const fill = document.getElementById("wqiFill");
  const scoreEl = document.getElementById("wqiScore");

  scoreEl.innerText = `${wqi} / 100`;
  fill.style.width = `${wqi}%`;

  if (wqi <= 40) fill.style.background = "#ef4444";
  else if (wqi <= 70) fill.style.background = "#f59e0b";
  else fill.style.background = "#22c55e";
}

// --- 1) AXIS CHART (FIXED) ---
const axisChart = new Chart(document.getElementById("axisChart"), {
  type: 'line',
  data: {
    labels: [],
    datasets: [{
      data: [],
      borderWidth: 0,
      pointRadius: 0
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    animation: false,
    plugins: { legend: { display: false } },
    scales: {
      x: { display: false },
      y: {
        ticks: { color: '#9ca3af', font: { size: 11 } },
        grid: { drawBorder: false, display: false }
      }
    },
    layout: { padding: { bottom: 25, left: 15, right: 5 } }
  }
});

// --- 2) DATA CHART ---
const dataChart = new Chart(document.getElementById("dataChart"), {
  type: 'line',
  data: {
    labels: [],
    datasets: [{
      data: [],
      borderColor: "#3b82f6",
      backgroundColor: "rgba(59, 130, 246, 0.1)",
      borderWidth: 2,
      tension: 0.3,
      pointRadius: 4,
      pointBackgroundColor: "#1b2230",
      fill: true
    }]
  },
  options: {
    responsive: false,
    maintainAspectRatio: false,
    animation: false,
    plugins: { legend: { display: false } },
    scales: {
      x: { ticks: { color: '#9ca3af' }, grid: { color: '#374151' } },
      y: { display: false }
    }
  }
});

// --- WEBSOCKET LOGIC ---
ws.onmessage = (e) => {
  const msg = JSON.parse(e.data);

  if (msg.type === "history") {
    fullHistory = msg.data || [];
    redrawGraph();

    if (fullHistory.length > 0) {
      updateCards(fullHistory[fullHistory.length - 1]);
    }
  }

  if (msg.type === "reading") {
    fullHistory.push(msg.data);
    if (fullHistory.length > 50) fullHistory.shift();

    updateCards(msg.data);
    redrawGraph();
  }

  if (msg.type === "reset") {
    fullHistory = [];
    redrawGraph();

    for (const key in markers) {
      map.removeLayer(markers[key]);
    }
    markers = {};

    alert("‚ö†Ô∏è Data Reset Done!");
  }
};

// ‚úÖ LOAD OLD HISTORY FROM FIREBASE (FIXED SORT using ts)
async function loadFirebaseHistory() {
  try {
    const res = await fetch(FIREBASE_HISTORY_URL);
    const histObj = await res.json();
    if (!histObj) return;

    const arr = Object.values(histObj);

    // ‚úÖ Correct sorting using numeric timestamp
    arr.sort((a, b) => (a.ts || 0) - (b.ts || 0));

    fullHistory = arr.slice(-50);

    redrawGraph();

    setTimeout(() => {
      scrollBox.scrollTo({ left: scrollBox.scrollWidth, behavior: "smooth" });
    }, 100);

    if (fullHistory.length > 0) {
      updateCards(fullHistory[fullHistory.length - 1]);
    }
  } catch (err) {
    console.log("firebase history error:", err.message);
  }
}
loadFirebaseHistory();

// ‚úÖ Fetch Latest Reading Button (FIXED ‚Üí reads Firebase latest even if server restarted)
document.getElementById("fetchBtn").addEventListener("click", async () => {
  try {
    const res = await fetch(FIREBASE_LATEST_URL);
    const data = await res.json();
    if (data && data.pH !== null && data.pH !== undefined) updateCards(data);
  } catch (err) {
    alert("‚ùå Failed to fetch latest reading");
  }
});

document.getElementById("metricSelect").addEventListener("change", (e) => {
  currentMetric = e.target.value;
  redrawGraph();
});

document.getElementById("scrollLeft").addEventListener("click", () => {
  scrollBox.scrollBy({ left: -200, behavior: "smooth" });
});

document.getElementById("scrollRight").addEventListener("click", () => {
  scrollBox.scrollBy({ left: 200, behavior: "smooth" });
});

function redrawGraph() {
  if (!fullHistory || fullHistory.length === 0) {
    axisChart.data.labels = [];
    axisChart.data.datasets[0].data = [];
    dataChart.data.labels = [];
    dataChart.data.datasets[0].data = [];
    axisChart.update();
    dataChart.update();
    return;
  }

  const labels = fullHistory.map(d => d.time);

  const data = fullHistory.map(d =>
    currentMetric === "tds" ? d.tds :
    currentMetric === "pH" ? d.pH :
    currentMetric === "temp" ? d.temp :
    d.turb
  );

  // ‚úÖ update dataChart
  dataChart.data.labels = labels;
  dataChart.data.datasets[0].data = data;

  // ‚úÖ update axisChart to force y-axis ticks to show
  axisChart.data.labels = labels;
  axisChart.data.datasets[0].data = data;

  let minVal = Math.min(...data);
  let maxVal = Math.max(...data);

  let padding = (maxVal - minVal) * 0.1;
  if (padding === 0) padding = 1;

  minVal -= padding;
  maxVal += padding;

  axisChart.options.scales.y.min = minVal;
  axisChart.options.scales.y.max = maxVal;

  dataChart.options.scales.y.min = minVal;
  dataChart.options.scales.y.max = maxVal;

  const totalPoints = fullHistory.length;
  const newWidth = Math.max(scrollBox.clientWidth, totalPoints * POINT_WIDTH);

  chartWrapper.style.width = newWidth + "px";

  const canvas = document.getElementById("dataChart");
  canvas.style.width = newWidth + "px";
  canvas.width = newWidth;
  canvas.height = 300;

  axisChart.update();
  dataChart.resize();
  dataChart.update();
}

function updateCards(d) {
  document.getElementById("ph").innerText = "pH: " + d.pH;
  document.getElementById("tds").innerText = "TDS: " + d.tds + " ppm";
  document.getElementById("temp").innerText = "Temp: " + d.temp + " ¬∞C";
  document.getElementById("turb").innerText = "Turbidity: " + d.turb;

  document.getElementById("phMetric").innerText = d.pH;
  document.getElementById("tdsMetric").innerText = d.tds;
  document.getElementById("tempMetric").innerText = d.temp + " ¬∞C";
  document.getElementById("turbMetric").innerText = d.turb;

  const sEl = document.getElementById("status");
  sEl.innerText = "Status: " + d.status;
  sEl.className = "value " + (d.status === "SAFE" ? "status-safe" : "status-unsafe");

  const wqi = calcWQI(d);
  setWQIUI(wqi);
}

/* ‚úÖ MAP LOGIC (PINS SYSTEM) */
const map = L.map("map").setView([21.1702, 72.8311], 12);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);

setTimeout(() => {
  map.invalidateSize();
}, 300);

let markers = {};

function getColor(status) {
  return status === "UNSAFE" ? "red" : "green";
}

async function loadMarkers() {
  try {
    const res = await fetch(`${FIREBASE_DB}/devices.json`);
    const devices = await res.json();
    if (!devices) return;

    for (const deviceId in devices) {
      const device = devices[deviceId];
      if (!device.pins) continue;

      for (const pinId in device.pins) {
        const d = device.pins[pinId];
        if (!d.lat || !d.lng) continue;

        const key = `${deviceId}_${pinId}`;
        const color = getColor(d.status || "SAFE");

        const popupText = `
          <b>${deviceId}</b><br>
          üß™ pH: ${d.pH}<br>
          üíß TDS: ${d.tds}<br>
          üå°Ô∏è Temp: ${d.temp}<br>
          üå´Ô∏è Turb: ${d.turb}<br>
          ‚ö†Ô∏è Status: <b style="color:${color}">${d.status}</b><br>
          üïí Time: ${d.time}
        `;

        if (markers[key]) {
          markers[key].setLatLng([d.lat, d.lng]);
          markers[key].setPopupContent(popupText);
          markers[key].setStyle({ color, fillColor: color });
        } else {
          const marker = L.circleMarker([d.lat, d.lng], {
            radius: 10,
            color: color,
            fillColor: color,
            fillOpacity: 0.85
          }).addTo(map);

          marker.bindPopup(popupText);
          markers[key] = marker;
        }
      }
    }
  } catch (err) {
    console.log("‚ùå map error:", err.message);
  }
}

// ‚úÖ reduced from 2 sec ‚Üí 5 sec (less firebase spam)
setInterval(loadMarkers, 5000);
loadMarkers();

document.getElementById("resetBtn").addEventListener("click", async () => {
  const pass = prompt("Enter Reset Password:");
  if (!pass) return;

  const ok = confirm("‚ö†Ô∏è Are you sure? This will delete all old Firebase data!");
  if (!ok) return;

  try {
    const res = await fetch(`/reset?password=${encodeURIComponent(pass)}&id=${DEVICE_ID}`);
    const txt = await res.text();

    if (!res.ok) {
      alert(txt);
      return;
    }

    alert("‚úÖ Reset Done!");

    fullHistory = [];
    redrawGraph();

    for (const key in markers) {
      map.removeLayer(markers[key]);
    }
    markers = {};

  } catch (err) {
    alert("‚ùå Reset failed: " + err.message);
  }
});
</script>

</body>
</html>
